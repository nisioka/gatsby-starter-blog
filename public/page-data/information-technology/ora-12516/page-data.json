{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/information-technology/ora-12516","result":{"data":{"allFile":{"edges":[]},"markdownRemark":null,"mdPrevious":null,"mdNext":null,"wpPost":{"id":"cG9zdDoyOTg=","title":"Oracle DBのセッションを増やすor強制終了する【ORA-12516対応】","content":"\n<p>ここでは、Oracle DBのセッションを強制終了する手順を説明します。</p>\n\n\n\n<p>強制終了しなければならない状況は色々とあるとは思いますが、以下のエラーが発生した場合なんかもそうかと思います。</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p><strong>ORA-12516: TNS: リスナーは、一致するプロトコル・スタックが使用可能なハンドラを検出できませんでした。</strong></p>\n</blockquote>\n\n\n\n<p>このエラーメッセージはかなりわかりにくいですね。意訳すると、「接続可能なリスナーが見つかりません」ぐらいでしょうか。基本的に処理が完了したら接続は開放されるのですが、異常終了した場合など、ゾンビ化して残り続けることがたまにあるようです（ただし1~2時間で切れるよう）。もし、頻発するようであれば切断処理に何かしらの問題があるやもしれません。</p>\n\n\n\n<h2 class=\"wp-block-heading\">手順</h2>\n\n\n\n<h3 class=\"wp-block-heading\">Ⅰ. sqlplusでsysdba権限でOracleにログインする</h3>\n\n\n\n<p>DBがどこにあるかによるので、以下のいづれかの方法でsqlplusにログインしてください。</p>\n\n\n\n<ol>\n<li class=\"bash\">ローカルにDBがある場合<br><br><code>sqlplus sys/パスワード as sysdba</code></li>\n\n\n\n<li class=\"bash\">外部サーバにDBがある場合<br><code>sqlplus sys/パスワード@データベース接続子 as sysdba</code><br><br>ここで、データベース接続子の記述方法についてもパターンがあります。\n<ol>\n<li class=\"bash\">「ホスト名:ポート番号/サービス名」の直接指定<br>例）<code>@192.168.1.1:1521/orcl</code></li>\n\n\n\n<li class=\"pgsql\">tnsnames.oraに接続定義されている場合<br>例）<code><code>@SAMPLE</code></code></li>\n</ol>\n</li>\n</ol>\n\n\n\n<pre class=\"wp-block-code language-pgsql has-medium-font-size\"><code><code># tnsnames.ora\nSAMPLE =\n  (DESCRIPTION =\n    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.1.1)(PORT = 1521))\n    (CONNECT_DATA =\n      (SERVICE_NAME = orcl)\n    )\n  )</code></code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">Ⅱ. V$RESOURCE_LIMITを検索して、セッション数を確認する</h3>\n\n\n\n<p>以下をsqlplusで実行します。</p>\n\n\n\n<h5 class=\"wp-block-heading\">1. 表示幅を増やす</h5>\n\n\n\n<p>場合によっては必要ないかもしれませんが、表示幅が長くなって表が崩れる可能性があるため、行サイズをとりあえず500にします。</p>\n\n\n\n<pre class=\"wp-block-code language-sql\"><code>set linesize 500</code></pre>\n\n\n\n<h5 class=\"wp-block-heading\">2. V$RESOURCE_LIMITを検索します</h5>\n\n\n\n<pre class=\"wp-block-code language-sql\"><code><code>select * \nfrom v$resource_limit</code></code></pre>\n\n\n\n<p>すると以下のような検索結果が出てきます。<br><br><img src=\"/_gatsby/file/8c49d56be912637c948b0c4ce7e7d2f3/VRESOURCE_LIMIT.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2FVRESOURCE_LIMIT.png\" alt=\"\" class=\"alignnone size-full wp-image-340 inline-gatsby-image-wrapper\"/><br><br>ここで、列説明をすると（英語の通りですが）、</p>\n\n\n\n<ul>\n<li>RESOURCE_NAMEは<strong>リソース名</strong>（おそらく、processes:プロセスとsessions:セッションが出てくるはずです）</li>\n\n\n\n<li>CURRENT_UTILIZATIONは<strong>現在使用数</strong></li>\n\n\n\n<li>MAX_UTILIZATIONは<strong>最大使用数</strong></li>\n\n\n\n<li>LIMIT_VALUEは<strong>上限値</strong>です。</li>\n</ul>\n\n\n\n<h5 class=\"wp-block-heading\">3. 検索結果を確認</h5>\n\n\n\n<p class=\"language-sql\">このとき、セッション数の現在使用数または最大使用数が上限値と同じもしくは近い場合は、セッション数不足ということがわかります。もし、そうでない場合は別の要因が考えられますので、残念ながらここでは解決できません。<br><br>セッション数不足の対応としては、当たり前ではありますが、セッション上限を増やすか/不要なセッションを消す（終了させる/殺す）という手段があります。どちらを選択すべきかはサーバ性能などにも依りますので一概には言えません。しかし、あくまで方針として言えば、以下を判断基準としてもよいと思います。</p>\n\n\n\n<ul>\n<li>定常的に使用するセッション数よりも過小に設定されてたり、サーバの性能（特にメモリ）に余裕があるのであればセッション上限を増やす<a href=\"#sessionIncrement\">↓</a></li>\n\n\n\n<li>アプリが異常終了してしまったことによる不要なセッションが大量に発生してしまったのが分かっていたり、取り急ぎアプリをDBアクセスしたい場合などはセッションを消す<a href=\"#sessionDelete\">↓</a></li>\n</ul>\n\n\n\n<h3 class=\"wp-block-heading\">Ⅲ-a. セッション上限を増やす<a id=\"sessionIncrement\"></a></h3>\n\n\n\n<h5 class=\"wp-block-heading\">1. セッション上限のパラメータがどこで定義されているか</h5>\n\n\n\n<p>Oracleのインスタンスを起動するときにこのセッション上限が決められるわけですが、その設定情報がどう定義されるかは2パターンあるため、まずどちらで定義されているかを確認する必要があります。</p>\n\n\n\n<ul>\n<li>pfile：テキスト形式の初期化パラメータファイル</li>\n\n\n\n<li>SPFILE：バイナリ形式のサーバパラメータファイル</li>\n</ul>\n\n\n\n<h5 class=\"wp-block-heading\">2. 定義情報の確認方法</h5>\n\n\n\n<p>sqlplusで以下を実行し、結果のVALUE列に、nullであればpfile、パスの情報があればSPFILEということがわかります。</p>\n\n\n\n<pre class=\"wp-block-code language-sql\"><code><code>show parameter spfile</code>\n実行例：\n<img loading=\"lazy\" decoding=\"async\" width=\"742\" height=\"124\" class=\"alignnone size-full wp-image-353\" src=\"/static/176531ff753b6cb8efd0dbbb7351bce3/2018-06-07_12h54_07.png\" alt=\"\" srcset=\"/static/176531ff753b6cb8efd0dbbb7351bce3/2018-06-07_12h54_07.png 742w, http://localhost/wp-content/uploads/2018/06/2018-06-07_12h54_07-300x50.png 300w, http://localhost/wp-content/uploads/2018/06/2018-06-07_12h54_07-320x53.png 320w\" sizes=\"(max-width: 742px) 100vw, 742px\" /></code></pre>\n\n\n\n<ul>\n<li>pfileの場合<br>Oracle公式の<a href=\"https://docs.oracle.com/cd/E49329_01/server.121/b71301/create.htm#i1014287\">こちら</a>を参照してください。</li>\n\n\n\n<li>SPFILEの場合<br>以下のDDLを実行します。ここでは&#8221;500&#8243;を指定していますので、適宜必要な数字に変更してください。<br>また、ロールバックができないことに留意してください。</li>\n</ul>\n\n\n\n<pre class=\"wp-block-code language-sql\"><code>alter system set processes = 500 scope=BOTH;</code></pre>\n\n\n\n<p class=\"language-sql\">実行例：<br><br><img src=\"/_gatsby/file/a8d24f589f546058bb7f977040c5c3ee/2018-06-07_13h03_11.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2F2018-06-07_13h03_11.png\" alt=\"\" class=\"alignnone size-full wp-image-356 inline-gatsby-image-wrapper\"/><br><br>これで完了です。scopeにBOTHを指定していますので、SPFILEにも現在実行中のDBインスタンスにも即時反映されていますので、DB再起動は不要です。</p>\n\n\n\n<h3 class=\"wp-block-heading\">Ⅲ-b. 不要なセッションを削除する</h3>\n\n\n\n<h5 class=\"wp-block-heading\">1. 詳細なセッション一覧を検索する<br><a id=\"sessionDelete\"></a></h5>\n\n\n\n<p>以下のSQLを実行して、削除に必要な情報を取得します。</p>\n\n\n\n<pre class=\"wp-block-code language-sql\"><code>select MACHINE, LOGON_TIME, SID, SERIAL#, USERNAME, OSUSER\nfrom V$SESSION</code></pre>\n\n\n\n<p>以下のような結果が取得されると思います（一部抜粋&amp;マスキングしてます）<br><br><img src=\"/_gatsby/file/7c384315ccf4e05203b8432dcffbbf2e/2018-06-06_13h14_40.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2F2018-06-06_13h14_40.png\" alt=\"\" class=\"alignnone size-full wp-image-350 inline-gatsby-image-wrapper\"/><br><br>これらの中から削除対象を選びます。これらは自己責任でお願いします。判断基準としては、ログイン日時が古かったり、対象のユーザで特定したりなどかと思われます。<br><br>削除に必要な情報は、`SID`と`SERIAL#`です。</p>\n\n\n\n<h5 class=\"wp-block-heading\">2. セッションを削除する</h5>\n\n\n\n<p>上記で削除したいセッションが特定できていれば、以下のSQLで削除します。繰り返しになりますが、自己責任で。<br><br>また、DDL文でもありますので、ロールバックができないことにも留意してください。</p>\n\n\n\n<pre class=\"wp-block-code language-sql\"><code>alter system kill session 'ここに対象のSIDを指定'</code></pre>\n\n\n\n<p>実行例：<br><br><img src=\"/_gatsby/file/3dce42de9aad9c8267a3cbffa18ebf80/2018-06-07_12h47_10.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2F2018-06-07_12h47_10.png\" alt=\"\" class=\"alignnone size-full wp-image-352 inline-gatsby-image-wrapper\"/><br></p>\n\n\n\n<h2 class=\"wp-block-heading\">参考</h2>\n\n\n\n<p><a href=\"http://out2dev.blogspot.jp/2012/03/ora-12516.html\">http://out2dev.blogspot.jp/2012/03/ora-12516.html</a></p>\n\n\n\n<p><a href=\"https://sql-oracle.com/?p=395\">https://sql-oracle.com/?p=395</a></p>\n\n\n\n<p><a href=\"http://at-j.co.jp/blog/?p=5468\">http://at-j.co.jp/blog/?p=5468</a></p>\n","excerpt":"<p>ここでは、Oracle DBのセッションを強制終了する手順を説明します。 強制終了しなければならない状況は色々とあるとは思いますが、以下のエラーが発生した場合なんかもそうかと思います。 ORA-12516: TNS: リ [&hellip;]</p>\n","slug":"ora-12516","date":"2018/06/07","modified":"2024/06/24","featuredImage":{"node":{"altText":"","gatsbyImage":{"images":{"sources":[{"srcSet":"/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/1e77d57018921b07e6b3725ba476bdf1/oracle-e1548303868367.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D64%26h%3D51%26fm%3Davif%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 64w,/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/3596268074d18c97ef9ce898bf9468a5/oracle-e1548303868367.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D128%26h%3D102%26fm%3Davif%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 128w,/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/76cc53e1339214c82bba734e8836554e/oracle-e1548303868367.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D256%26h%3D205%26fm%3Davif%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 256w","type":"image/avif","sizes":"(min-width: 256px) 256px, 100vw"},{"srcSet":"/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/e999135f6ae700b07b174b0ad1171a42/oracle-e1548303868367.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D64%26h%3D51%26fm%3Dwebp%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 64w,/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/01c022208c2cd4d6551397e3b03c3c2a/oracle-e1548303868367.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D128%26h%3D102%26fm%3Dwebp%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 128w,/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/d7e36cf2a3f98a055a05c08b73d447b6/oracle-e1548303868367.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D256%26h%3D205%26fm%3Dwebp%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 256w","type":"image/webp","sizes":"(min-width: 256px) 256px, 100vw"}],"fallback":{"src":"/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/d7d31482a920f1005852ff46dac23cb5/oracle-e1548303868367.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D64%26h%3D51%26fm%3Djpg%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f","srcSet":"/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/d7d31482a920f1005852ff46dac23cb5/oracle-e1548303868367.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D64%26h%3D51%26fm%3Djpg%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 64w,/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/7d03072d064d20b011bced4df6097c42/oracle-e1548303868367.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D128%26h%3D102%26fm%3Djpg%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 128w,/_gatsby/image/f7f9c33f7c0ae16b8717415eac5cb419/6481ac1d91a583a88f9af1debae416d3/oracle-e1548303868367.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2018%2F06%2Foracle-e1548303868367.jpg&a=w%3D256%26h%3D205%26fm%3Djpg%26q%3D75&cd=ad771aff65b5e10230ef26812c4ecf3f 256w","sizes":"(min-width: 256px) 256px, 100vw"}},"layout":"constrained","width":256,"height":205,"backgroundColor":"rgb(120,136,152)"}}},"categories":{"nodes":[{"name":"技術"}]},"tags":{"nodes":[{"name":"database"},{"name":"ORA-12516"},{"name":"oracle"},{"name":"proceses"},{"name":"session"}]}},"wpPrevious":{"title":"Spring Bootの2.7系から3.1系へのバージョンアップ対応のハマりどころ","slug":"spring-boot_vertion-up_2-7to3-1","categories":{"nodes":[{"name":"技術"}]}},"wpNext":null},"pageContext":{"id":"cG9zdDoyOTg=","previousPostId":"cG9zdDozMDcw","nextPostId":null,"imagePath":null}},"staticQueryHashes":["2488138200","3280520893"],"slicesMap":{}}